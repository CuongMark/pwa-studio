# This is the UPWARD specification file for the Venia storefront.
# It is used by an UPWARD server implementation, such as upward-js and
# upward-php, to describe how the server responds to requests.

# The root properties of an UPWARD spec file are part of a global context
# that includes request and environment data.
# These properties are available to other properties and are ultimately
# populated with Resolvers.

# The root 'status', 'headers', and 'body' properties are required properties
# in an UPWARD spec file.
# An UPWARD server uses the resolved values of these properties to create an
# HTTP response to the client.
# In this example, these properties get their values from a top-level 
# 'response' object, which is a recommended and best practice approach.
status: response.status
headers: response.headers
body: response.body

# This is a top-level object used to set values for the root `status`,
# `headers`, and `body` properties.
# It is the first branch in an abstract decision tree, which ultimately 
# resolves to an object that contains values for its own 'status', 'headers',
# and 'body' properties.
# This object uses a ConditionalResolver to determine the object value based 
# on the URL pattern in the request object.
response:
  when:
    # This URL pattern requests a compressed image from the server.
    # The resolution path is directed to the top-level `imageOpt` object.
    - matches: request.url.pathname
      pattern: '^/img/resize/(\d+)'
      use: imageOpt
    # Requests to graphql/rest endpoints, the media library, and cache are
    # handled by the top-level 'proxy' object, which is a ProxyResolver
    # that passes the request through to the backing Magento server.
    - matches: request.url.pathname
      pattern: '^/(graphql|rest|media|cache/)'
      use: proxy
    # Requests to create an account are handled by the top-level 'index'
    # object, which returns a generic app shell since the feature has
    # not been implemented.
    - matches: request.url.pathname
      pattern: '^/create-account'
      use: index
    # Requests for static resources provided by the application project, such
    # as icons, manifests, and static images, are handled by the top-level
    # 'static' object.
    - matches: request.url.pathname
      pattern: '^/(icons/.+|favicon.ico$|manifest.json$|veniaClosed.png$)'
      use: static
    # Requests with a URL key are handled by the top-level 'appShell' object.
    # The existence of a URL key is determined using the top-level 'urlKey'
    # object.
    - matches: urlKey
      pattern: '.'
      use: appShell
    # Requests to the document root, i.e. having no URL key, is also handled
    # by the top-level 'appShell' object.
    - matches: request.url.pathname
      pattern: '^/$'
      use: appShell
  # If the none of the tested conditions pass, the default handler for the
  # request is the top-level 'bundles' object.
  default: bundles

# In dev and staging mode, the PWADevServer and Venia's server.js both declare
# the image resizing middleware at `/img/` before the UpwardPlugin declares
# middleware, so a request should never get here.

# In production mode when USE_FASTLY is true, the Venia PWA has a
# Fastly-specific URL factory. It should also never hit this route.

# In production mode when the PWA has NOT built a Fastly-specific URL factory,
# this forwards to Fastly where it is present, and drops back to the
# uncompressed image otherwise. If this will run on a non-FastlyIO server, an
# onboard resizing service is highly recommended.
imageOpt:
  inline:
    status: 301
    body:
      inline: ''
    headers:
      inline:
        Location:
          engine: mustache
          provide:
            width: $match.$1
            path: request.url.query.url
          template:
            when:
              - matches: env.USE_FASTLY
                pattern: '[^0]'
                use:
                  inline: '{{path}}?auto=webp&format=pjpg&width={{width}}'
            default:
              inline: '{{path}}'

isDevelopment:
  when:
    - matches: env.NODE_ENV
      pattern: 'development'
      use:
        inline: true
  default:
    inline: false

proxy:
  target: env.MAGENTO_BACKEND_URL
  # A local Magento install may have SSH configured and untrusted,
  # which is not a major concern, especially if containerized.
  ignoreSSLErrors:
    inline: true

appShell:
  inline:
    status:
      when:
        - matches: resource.model
          pattern: '.'
          use: 200
      default: 404
    headers:
      inline:
        content-type: 'text/html'
    body:
      engine: mustache
      template: resource.template
      provide:
        model: resource.model
        bundles: assetManifest.bundles
        urlResolver: urlResolver
        env: env

resource:
  when:
    - matches: urlResolver.type
      pattern: 'CMS_PAGE'
      use:
        inline:
          model: cmsPage
          template: './templates/cmspage-shell.mst'
    - matches: urlResolver.type
      pattern: 'CATEGORY'
      use:
        inline:
          model: category
          template: './templates/category-shell.mst'
    - matches: urlResolver.type
      pattern: 'PRODUCT'
      use:
        inline:
          model: product
          template: './templates/product-shell.mst'
    - matches: urlResolver.type
      pattern: '.'
      use:
        inline:
          model: unknownPageType
          template: './templates/generic-shell.mst'
    - matches: request.url.pathname
      pattern: '/search.html'
      use:
        inline:
          model: genericObject
          template: './templates/generic-shell.mst'
  default:
    inline:
      template: './templates/notfound-shell.mst'

assetManifest:
  when:
    - matches: env.NODE_ENV
      pattern: 'development'
      use: ./asset-manifest.json
  default: ./dist/asset-manifest.json

unknownPageType:
  inline:
    title: 'Unknown page type'

urlResolver: urlResolverResult.data.urlResolver

urlResolverResult:
  url: magentoGQL
  query: './src/queries/urlResolver.graphql'
  variables:
    inline:
      urlKey: request.url.pathname

magentoGQL:
  engine: mustache
  template:
    inline: '{{env.MAGENTO_BACKEND_URL}}/graphql'
  provide:
    - env

product: productResult.data.productDetail.items.0
productResult:
  url: magentoGQL
  query: './src/queries/getProductDetail.graphql'
  variables:
    inline:
      onServer: true
      urlKey: urlKey
      id: urlResolver.id

category: categoryResult.data.category
categoryResult:
  url: magentoGQL
  query: './src/queries/getCategory.graphql'
  variables:
    inline:
      onServer: true
      id: urlResolver.id
      pageSize:
        inline: 1
      currentPage:
        inline: 1


cmsPage: cmsPageResult.data.cmsPage
cmsPageResult:
  url: magentoGQL
  query: './src/queries/getCmsPage.graphql'
  variables:
    inline:
      onServer: true
      id: urlResolver.id

urlKey:
  when:
    - matches: request.url.pathname
      pattern: '^/(?:(.*)\.html)?'
      use: $match.$1
  default:
    inline: ''

genericObject:
  inline:
    name:
      inline:
        "Hello world!"

bundles:
  directory:
    inline: './dist'

index:
  inline:
    status: 200
    headers:
      inline:
        content-type:
          inline: text/html
    body:
      engine: mustache
      template: './templates/generic-shell.mst'
      provide:
        isDevelopment: isDevelopment

static:
  directory:
    inline: './static'
